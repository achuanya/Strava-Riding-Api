# Strava骑行数据获取工具

这个脚本用于从Strava API获取指定用户当年的所有骑行活动数据，并将其保存为JSON格式。

## 功能特点

- 自动处理OAuth 2.0认证
- 获取今年所有的骑行活动
- 获取每个活动的完整详细信息
- 支持分页处理大量数据
- 将结果保存为JSON文件
- 自动令牌刷新机制
- 支持手动授权码输入备选方案

## 使用前设置

**重要：** 在使用此脚本前，请确保在Strava开发者平台上正确配置您的应用：

1. 访问 [Strava开发者设置](https://www.strava.com/settings/api)
2. 将以下URL添加到"授权回调域"：
   ```
   localhost
   ```
   注意：只需输入 `localhost` 而不是完整的 `http://localhost:8000`
3. 保存设置

## 使用方法

1. 安装依赖：
   ```
   yarn install
   ```

2. 获取并处理授权码：
   ```
   yarn auth
   ```
   获取授权后，您会收到一个授权码。将其粘贴到命令行中。

3. 获取骑行数据：
   ```
   yarn start
   ```
   
4. 查看输出的JSON文件，文件名格式为：`strava_rides_YYYY_YYYY-MM-DD.json`

## 版本说明 (2025-03-25 更新)

- 增强了API请求的兼容性，解决了"protocol mismatch"错误
- 添加了备用请求方法，提高数据获取成功率
- 改进了错误处理和调试信息

## 解决认证问题

如果您遇到API相关错误，请尝试以下解决方案：

1. **更新令牌**：
   ```
   yarn auth
   ```
   重新获取授权并更新令牌

2. **检查API状态**：
   访问 [Strava API状态](https://status.strava.com/) 确认服务是否正常

3. **使用原生HTTPS模块**：
   脚本已更新为使用Node.js原生HTTPS模块，以解决"protocol mismatch"错误

4. **网络问题**：
   确保您的网络能够访问Strava API，检查是否需要配置代理

## 手动授权步骤（如需要）

如果自动授权流程失败，您可以通过以下步骤手动授权：

1. 复制脚本提供的授权链接并在浏览器中打开
2. 登录您的Strava账号并授权应用
3. 授权后，您将被重定向到一个可能无法访问的页面
4. 从浏览器地址栏复制完整URL（包含授权码）
5. 将URL粘贴到脚本的输入提示中

## 常见问题解决

1. **"protocol mismatch"错误**：
   - 此问题已在最新版本中解决，使用了原生HTTPS模块发送请求
   - 确保在Strava开发者设置中添加了`localhost`作为授权回调域

2. **无法获取活动数据**：
   - 确认您的账户中确实有骑行活动
   - 检查筛选条件是否正确（默认只获取"Ride"类型活动）

3. **API错误或限流**：
   - Strava API有使用限制(每15分钟100次，每天1000次)
   - 数据量大时，脚本已添加延迟以避免触发限流

## 注意事项

- Strava API有速率限制，脚本中已添加延迟以避免超过限制
- 默认只获取"骑行"(Ride)类型的活动
- 如需修改用户ID或获取其他类型的活动，请编辑脚本中的相关参数
- 令牌会保存在项目目录下的`.strava_token.json`文件中，请保护该文件的安全
